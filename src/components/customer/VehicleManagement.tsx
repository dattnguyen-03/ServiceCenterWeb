import React, { useState, useEffect } from 'react';
import { Row, Col, Button, Modal, Spin, Card, Tag, Timeline, Input, Tooltip } from 'antd';
import { CarOutlined, PlusOutlined, EditOutlined, DeleteOutlined, EyeOutlined, ReloadOutlined } from '@ant-design/icons';
import { VehicleResponse } from '../../types/api';
import { vehicleService } from '../../services/vehicleService';
import AddVehicleForm from './AddVehicleForm';
import { showError, showDeleteConfirm, showLoading, closeLoading, showSuccess } from '../../utils/sweetAlert';

const VehicleManagement: React.FC = () => {
  const [vehicles, setVehicles] = useState<VehicleResponse[]>([]);
  const [loading, setLoading] = useState(true);
  const [refreshing, setRefreshing] = useState(false);
  const [showAddForm, setShowAddForm] = useState(false);
  const [editingVehicle, setEditingVehicle] = useState<VehicleResponse | null>(null);
  const [selectedVehicle, setSelectedVehicle] = useState<VehicleResponse | null>(null);
  const [detailModalVisible, setDetailModalVisible] = useState(false);
  const [searchText, setSearchText] = useState('');

  // Load vehicles from API
  useEffect(() => {
    loadVehicles();
  }, []);

  const loadVehicles = async () => {
    try {
      setLoading(true);
      const vehicles = await vehicleService.getVehiclesByCustomer();
      setVehicles(vehicles);
    } catch (error: any) {
      console.error('Error loading vehicles:', error);
      showError('L·ªói t·∫£i d·ªØ li·ªáu', error.message || 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch xe');
      setVehicles([]);
    } finally {
      setLoading(false);
    }
  };

  const handleAddVehicle = () => {
    setShowAddForm(true);
  };

  const handleAddSuccess = () => {
    setShowAddForm(false);
    loadVehicles();
  };

  const handleEditVehicle = (vehicle: VehicleResponse) => {
    setEditingVehicle(vehicle);
  };

  const handleViewDetail = (vehicleId: number) => {
    const vehicle = vehicles.find(v => v.vehicleID === vehicleId);
    if (vehicle) {
      setSelectedVehicle(vehicle);
      setDetailModalVisible(true);
    }
  };

  const handleDeleteVehicle = async (vehicleId: number) => {
    const result = await showDeleteConfirm('xe n√†y');

    if (result.isConfirmed) {
      try {
        showLoading('ƒêang x√≥a xe...');
        const response = await vehicleService.deleteVehicle(vehicleId);
        closeLoading();
        
        if (response.success) {
          showSuccess('Th√†nh c√¥ng', 'X√≥a xe th√†nh c√¥ng!');
          loadVehicles();
        } else {
          showError('Kh√¥ng th·ªÉ x√≥a xe', response.message || 'C√≥ l·ªói x·∫£y ra khi x√≥a xe');
        }
      } catch (error: any) {
        closeLoading();
        showError('L·ªói x√≥a xe', error.message || 'Kh√¥ng th·ªÉ x√≥a xe');
      }
    }
  };

  if (loading) {
    return (
      <div className="p-4 md:p-8">
        <div className="flex justify-center items-center h-64">
          <Spin size="large" />
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-sky-50 via-white to-blue-50 p-4 md:p-8">
      <style>{`
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .vehicle-card { animation: slideIn 0.5s ease-out forwards; }
        .header-section { animation: fadeIn 0.6s ease-out; }
      `}</style>

      <div className="max-w-7xl mx-auto">
        {/* Header Section */}
        <div className="header-section mb-8">
          <div className="flex flex-col gap-2 mb-6">
            <h1 className="text-4xl font-bold bg-gradient-to-r from-blue-600 to-cyan-600 bg-clip-text text-transparent">
              üöó Xe C·ªßa T√¥i
            </h1>
            <p className="text-gray-600 text-base">
              Qu·∫£n l√Ω th√¥ng tin v√† l·ªãch s·ª≠ b·∫£o d∆∞·ª°ng c√°c xe ƒëi·ªán c·ªßa b·∫°n
            </p>
          </div>

          {/* Filter & Action Bar */}
          <div className="bg-white/80 backdrop-blur-sm border border-blue-200 rounded-xl p-4 shadow-md flex flex-col md:flex-row gap-3 items-start md:items-center md:justify-between">
            <div className="flex-1 w-full md:w-auto">
              <Input.Search
                allowClear
                placeholder="üîç T√¨m theo model, bi·ªÉn s·ªë..."
                value={searchText}
                onChange={e => setSearchText(e.target.value)}
                className="w-full"
                style={{
                  backgroundColor: '#f8fafc',
                  borderColor: '#bfdbfe',
                  color: '#1e293b'
                }}
              />
            </div>

            <div className="flex items-center gap-2">
              <Tooltip title="L√†m m·ªõi">
                <button
                  className={`h-10 px-3 flex items-center justify-center rounded-lg bg-gradient-to-r from-blue-500 to-cyan-500 text-white hover:shadow-lg transition-all duration-200 ${
                    refreshing ? 'opacity-60 scale-95' : 'hover:scale-105'
                  }`}
                  onClick={async () => {
                    setRefreshing(true);
                    await loadVehicles();
                    setRefreshing(false);
                  }}
                >
                  <ReloadOutlined className={refreshing ? 'animate-spin' : ''} />
                </button>
              </Tooltip>

              <Button
                type="primary"
                size="large"
                icon={<PlusOutlined />}
                onClick={handleAddVehicle}
                className="!bg-gradient-to-r !from-blue-600 !to-cyan-600 hover:!from-blue-700 hover:!to-cyan-700 !border-0 !rounded-lg !h-10 !px-6 !font-semibold !shadow-md hover:!shadow-lg transition-all duration-300"
              >
                Th√™m xe
              </Button>
            </div>
          </div>
        </div>

        {/* Content Section */}
        {loading ? (
          <div className="flex justify-center items-center py-24">
            <Spin size="large" tip="ƒêang t·∫£i..." />
          </div>
        ) : (
          <Row gutter={[24, 24]}>
            {vehicles.length === 0 ? (
              <Col span={24}>
                <div className="text-center py-20">
                  <div className="text-6xl mb-4">üöó</div>
                  <h3 className="text-2xl font-semibold text-gray-700 mb-3">Ch∆∞a c√≥ xe n√†o</h3>
                  <p className="text-gray-500 mb-8 max-w-md mx-auto leading-relaxed">
                    H√£y th√™m xe ƒë·∫ßu ti√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu qu·∫£n l√Ω b·∫£o d∆∞·ª°ng v√† theo d√µi l·ªãch s·ª≠ d·ªãch v·ª•
                  </p>
                  <Button 
                    type="primary" 
                    size="large"
                    icon={<PlusOutlined />}
                    onClick={handleAddVehicle}
                    className="!bg-gradient-to-r !from-blue-600 !to-cyan-600 hover:!from-blue-700 hover:!to-cyan-700 !border-0 !h-12 !px-8 !text-base !font-medium !rounded-lg !shadow-lg hover:!shadow-xl transition-all duration-300"
                  >
                    Th√™m xe ƒë·∫ßu ti√™n
                  </Button>
                </div>
              </Col>
            ) : (
          vehicles
            .filter(v => 
              !searchText || 
              v.model.toLowerCase().includes(searchText.toLowerCase()) || 
              v.licensePlate.toLowerCase().includes(searchText.toLowerCase())
            )
            .map((vehicle, idx) => (
            <Col key={vehicle.vehicleID} xs={24} sm={12} lg={8}>
              <div
                className="vehicle-card"
                style={{ animationDelay: `${idx * 50}ms` }}
              >
                <Card
                  className="h-full bg-gradient-to-br from-white to-blue-50 border-blue-200 hover:border-cyan-400 transition-all duration-300 hover:shadow-lg hover:shadow-cyan-300/30 overflow-hidden group"
                  style={{ borderRadius: 16 }}
                  bodyStyle={{ padding: 0 }}
                >
                  {/* Header with gradient */}
                  <div
                    className="p-6 bg-gradient-to-br from-blue-600 to-cyan-600 text-white relative overflow-hidden"
                  >
                    <div className="absolute inset-0 opacity-10">
                      <CarOutlined className="text-8xl absolute -right-4 -top-4" />
                    </div>
                    <div className="relative z-10">
                      <div className="flex items-start justify-between mb-3">
                        <div className="w-12 h-12 bg-white/20 backdrop-blur-sm rounded-lg flex items-center justify-center">
                          <CarOutlined className="text-xl text-white" />
                        </div>
                        <Tag className="text-xs" style={{ backgroundColor: 'rgba(255,255,255,0.2)', borderColor: '#fff', color: '#fff' }}>
                          NƒÉm {vehicle.year}
                        </Tag>
                      </div>
                      <h3 className="text-2xl font-bold mb-2">{vehicle.model}</h3>
                      <p className="text-sm text-blue-100">üìã {vehicle.licensePlate}</p>
                    </div>
                  </div>

                  {/* Content */}
                  <div className="p-4 space-y-3">
                    {/* Quick Stats */}
                    <div className="grid grid-cols-2 gap-2">
                      <div style={{
                        background: 'linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%)',
                        padding: 10,
                        borderRadius: 8,
                        border: '1px solid #bae6fd'
                      }}>
                        <div style={{ fontSize: 11, color: '#0c4a6e', fontWeight: 600, marginBottom: 4 }}>‚ö° Pin</div>
                        <div style={{ fontSize: 14, fontWeight: 700, color: '#0284c7' }}>
                          {vehicle.batteryCapacity || 'N/A'}
                        </div>
                      </div>

                      <div style={{
                        background: 'linear-gradient(135deg, #f0fdf4 0%, #f9fafb 100%)',
                        padding: 10,
                        borderRadius: 8,
                        border: '1px solid #dcfce7'
                      }}>
                        <div style={{ fontSize: 11, color: '#166534', fontWeight: 600, marginBottom: 4 }}>üìç Km</div>
                        <div style={{ fontSize: 14, fontWeight: 700, color: '#16a34a' }}>
                          {(vehicle.mileage || 0).toLocaleString()}
                        </div>
                      </div>
                    </div>

                    {/* VIN */}
                    <div style={{
                      background: '#f3f4f6',
                      padding: 8,
                      borderRadius: 6,
                      fontSize: 11,
                      fontFamily: 'monospace',
                      color: '#374151',
                      overflow: 'hidden',
                      textOverflow: 'ellipsis',
                      whiteSpace: 'nowrap'
                    }}>
                      VIN: {vehicle.vin}
                    </div>

                    {/* Action Buttons */}
                    <div className="flex gap-2 pt-2">
                      <Button
                        size="small"
                        icon={<EyeOutlined />}
                        onClick={() => {
                          setSelectedVehicle(vehicle);
                          setDetailModalVisible(true);
                        }}
                        className="flex-1 !h-9 !rounded-lg !border-blue-300 !text-blue-600 hover:!border-blue-500 hover:!text-blue-700 !bg-blue-50 hover:!bg-blue-100 !font-medium"
                      >
                        Chi ti·∫øt
                      </Button>
                      <Button
                        size="small"
                        icon={<EditOutlined />}
                        onClick={() => handleEditVehicle(vehicle)}
                        className="flex-1 !h-9 !rounded-lg !border-gray-300 !text-gray-600 hover:!border-blue-400 hover:!text-blue-600 !bg-white hover:!bg-blue-50 !font-medium"
                      >
                        S·ª≠a
                      </Button>
                    </div>

                    <Button
                      size="small"
                      danger
                      icon={<DeleteOutlined />}
                      onClick={() => handleDeleteVehicle(vehicle.vehicleID)}
                      className="w-full !h-9 !rounded-lg !font-medium"
                    >
                      X√≥a
                    </Button>
                  </div>
                </Card>
              </div>
            </Col>
            ))
            )}
          </Row>
        )}

      </div>

      {/* Add Vehicle Modal */}
      <Modal
        title="Th√™m xe m·ªõi"
        open={showAddForm}
        onCancel={() => setShowAddForm(false)}
        footer={null}
        width={800}
        destroyOnHidden
      >
        <AddVehicleForm 
          onSuccess={handleAddSuccess}
          onCancel={() => setShowAddForm(false)}
        />
      </Modal>

      {/* Edit Vehicle Modal */}
      <Modal
        title="Ch·ªânh s·ª≠a xe"
        open={!!editingVehicle}
        onCancel={() => setEditingVehicle(null)}
        footer={null}
        width={800}
        destroyOnHidden
      >
        {editingVehicle && (
          <AddVehicleForm 
            initialData={editingVehicle}
            onSuccess={() => {
              setEditingVehicle(null);
              loadVehicles();
            }}
            onCancel={() => setEditingVehicle(null)}
          />
        )}
      </Modal>

      {/* Vehicle Detail Modal */}
      <Modal
        title={
          <div style={{ fontSize: 18, fontWeight: 700, color: '#1f2937' }}>
            üöó Chi ti·∫øt xe - {selectedVehicle?.model}
          </div>
        }
        open={detailModalVisible}
        onCancel={() => setDetailModalVisible(false)}
        footer={null}
        width={900}
        destroyOnHidden
        style={{ maxHeight: '90vh' }}
        bodyStyle={{ maxHeight: '70vh', overflowY: 'auto' }}
      >
        {selectedVehicle && (
          <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>
            {/* Vehicle Info */}
            <Card 
              style={{
                borderRadius: 12,
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                border: '1px solid #e5e7eb'
              }}
              bodyStyle={{ padding: 16 }}
            >
              <div style={{ fontSize: 14, fontWeight: 700, color: '#1f2937', marginBottom: 16 }}>
                ‚ÑπÔ∏è Th√¥ng tin xe
              </div>
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12 }}>
                <div>
                  <div style={{ fontSize: 12, color: '#6b7280', marginBottom: 4, fontWeight: 600 }}>Model xe</div>
                  <div style={{ fontSize: 15, fontWeight: 700, color: '#1f2937' }}>{selectedVehicle.model}</div>
                </div>
                <div>
                  <div style={{ fontSize: 12, color: '#6b7280', marginBottom: 4, fontWeight: 600 }}>NƒÉm s·∫£n xu·∫•t</div>
                  <Tag style={{ borderRadius: 6, fontWeight: 600, padding: '2px 8px' }} color="blue">
                    {selectedVehicle.year}
                  </Tag>
                </div>
                <div style={{ gridColumn: '1 / -1' }}>
                  <div style={{ fontSize: 12, color: '#6b7280', marginBottom: 4, fontWeight: 600 }}>VIN</div>
                  <code style={{
                    background: '#f3f4f6',
                    padding: '6px 10px',
                    borderRadius: 6,
                    fontSize: 13,
                    fontFamily: 'monospace',
                    color: '#1f2937',
                    display: 'block',
                    wordBreak: 'break-all'
                  }}>
                    {selectedVehicle.vin}
                  </code>
                </div>
                <div>
                  <div style={{ fontSize: 12, color: '#6b7280', marginBottom: 4, fontWeight: 600 }}>Bi·ªÉn s·ªë xe</div>
                  <Tag style={{ borderRadius: 6, fontWeight: 600, padding: '2px 8px' }} color="green">
                    {selectedVehicle.licensePlate}
                  </Tag>
                </div>
                <div>
                  <div style={{ fontSize: 12, color: '#6b7280', marginBottom: 4, fontWeight: 600 }}>ID xe</div>
                  <Tag style={{ borderRadius: 6, fontWeight: 600, padding: '2px 8px' }} color="purple">
                    #{selectedVehicle.vehicleID}
                  </Tag>
                </div>
                {selectedVehicle.notes && (
                  <div style={{ gridColumn: '1 / -1' }}>
                    <div style={{ fontSize: 12, color: '#6b7280', marginBottom: 4, fontWeight: 600 }}>Ghi ch√∫</div>
                    <div style={{
                      background: '#f9fafb',
                      padding: 10,
                      borderRadius: 6,
                      border: '1px solid #e5e7eb',
                      color: '#4b5563',
                      fontSize: 13
                    }}>
                      {selectedVehicle.notes}
                    </div>
                  </div>
                )}
              </div>
            </Card>

            {/* Stats */}
            <Card 
              style={{
                borderRadius: 12,
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                border: '1px solid #e5e7eb'
              }}
              bodyStyle={{ padding: 16 }}
            >
              <div style={{ fontSize: 14, fontWeight: 700, color: '#1f2937', marginBottom: 16 }}>
                üìä Th·ªëng k√™
              </div>
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12 }}>
                <div style={{
                  background: 'linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%)',
                  padding: 12,
                  borderRadius: 8,
                  border: '1px solid #bae6fd'
                }}>
                  <div style={{ fontSize: 11, color: '#0c4a6e', marginBottom: 4, fontWeight: 600 }}>‚ö° Dung l∆∞·ª£ng pin</div>
                  <div style={{ fontSize: 16, fontWeight: 700, color: '#0284c7 ' }}>
                    {selectedVehicle.batteryCapacity || 'N/A'}
                  </div>
                </div>

                <div style={{
                  background: 'linear-gradient(135deg, #f0fdf4 0%, #f9fafb 100%)',
                  padding: 12,
                  borderRadius: 8,
                  border: '1px solid #dcfce7'
                }}>
                  <div style={{ fontSize: 11, color: '#166534', marginBottom: 4, fontWeight: 600 }}>üìç Qu√£ng ƒë∆∞·ªùng</div>
                  <div style={{ fontSize: 16, fontWeight: 700, color: '#16a34a' }}>
                    {(selectedVehicle.mileage || 0).toLocaleString()} km
                  </div>
                </div>
              </div>
            </Card>

            {/* Maintenance History */}
            <Card 
              style={{
                borderRadius: 12,
                boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                border: '1px solid #e5e7eb'
              }}
              bodyStyle={{ padding: 16 }}
            >
              <div style={{ fontSize: 14, fontWeight: 700, color: '#1f2937', marginBottom: 16 }}>
                üîß L·ªãch s·ª≠ b·∫£o d∆∞·ª°ng
              </div>
              <Timeline
                items={[
                  {
                    dot: (
                      <div style={{
                        width: 32,
                        height: 32,
                        background: 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)',
                        borderRadius: 50,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        color: '#fff',
                        fontWeight: 700,
                        fontSize: 14,
                        boxShadow: '0 2px 6px rgba(34, 197, 94, 0.3)'
                      }}>
                        ‚úì
                      </div>
                    ),
                    children: (
                      <div style={{
                        background: 'linear-gradient(135deg, #f0fdf4 0%, #f9fafb 100%)',
                        border: '1px solid #dcfce7',
                        borderRadius: 8,
                        padding: 12,
                        marginLeft: 12
                      }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: 8 }}>
                          <div>
                            <p style={{ fontWeight: 600, fontSize: 14, color: '#1f2937', margin: 0, marginBottom: 2 }}>
                              B·∫£o d∆∞·ª°ng cu·ªëi c√πng
                            </p>
                            <p style={{ fontSize: 12, color: '#6b7280', margin: 0 }}>Ki·ªÉm tra t·ªïng th·ªÉ</p>
                          </div>
                          <Tag style={{ borderRadius: 4, fontWeight: 600, fontSize: 11 }} color="green">
                            ‚úÖ Ho√†n t·∫•t
                          </Tag>
                        </div>
                        <p style={{ fontSize: 12, color: '#374151', margin: 0 }}>
                          üìÖ {selectedVehicle.lastServiceDate ? new Date(selectedVehicle.lastServiceDate).toLocaleDateString('vi-VN') : 'Ch∆∞a c√≥'}
                        </p>
                      </div>
                    )
                  },
                  {
                    dot: (
                      <div style={{
                        width: 32,
                        height: 32,
                        background: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',
                        borderRadius: 50,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        color: '#fff',
                        fontWeight: 700,
                        fontSize: 14,
                        boxShadow: '0 2px 6px rgba(245, 158, 11, 0.3)'
                      }}>
                        ‚è±
                      </div>
                    ),
                    children: (
                      <div style={{
                        background: 'linear-gradient(135deg, #fefce8 0%, #f9fafb 100%)',
                        border: '1px solid #fef08a',
                        borderRadius: 8,
                        padding: 12,
                        marginLeft: 12
                      }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: 8 }}>
                          <div>
                            <p style={{ fontWeight: 600, fontSize: 14, color: '#1f2937', margin: 0, marginBottom: 2 }}>
                              B·∫£o d∆∞·ª°ng ti·∫øp theo
                            </p>
                            <p style={{ fontSize: 12, color: '#6b7280', margin: 0 }}>B·∫£o d∆∞·ª°ng ƒë·ªãnh k·ª≥</p>
                          </div>
                          <Tag style={{ borderRadius: 4, fontWeight: 600, fontSize: 11 }} color="orange">
                            üìÖ S·∫Øp ƒë·∫øn
                          </Tag>
                        </div>
                        <p style={{ fontSize: 12, color: '#374151', margin: 0 }}>
                          {selectedVehicle.nextServiceDate ? new Date(selectedVehicle.nextServiceDate).toLocaleDateString('vi-VN') : 'Ch∆∞a c√≥'}
                        </p>
                      </div>
                    )
                  }
                ]}
              />
            </Card>
          </div>
        )}
      </Modal>
    </div>
  );
};

export default VehicleManagement;